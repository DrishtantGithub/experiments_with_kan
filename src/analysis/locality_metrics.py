"""
Locality & Support Width Analysis for KAN vs MLP/CNN models.

This script loads the activation CSVs generated by:
    src/analysis/activation_response.py

It computes:
  - Locality Index
  - Support Width
  - Peak region boundaries
  - Normalized Activation Mass
  - Comparison plots

Usage Example (Toy):
  python -m src.analysis.locality_metrics \
      --kan-dir ./results/interpretability/activation_response/toy/kan \
      --baseline-dir ./results/interpretability/activation_response/toy/baseline \
      --save-dir ./results/interpretability/locality/toy

Usage Example (CNN):
  python -m src.analysis.locality_metrics \
      --kan-dir ./results/interpretability/activation_response/cifar/kan_cnn \
      --baseline-dir ./results/interpretability/activation_response/cifar/baseline_cnn \
      --save-dir ./results/interpretability/locality/cifar
"""

import argparse
import os
from pathlib import Path
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd


def compute_locality_metrics(arr, threshold_ratio=0.2):
    """
    arr: 2D array (units x samples)
    threshold_ratio: fraction of max activation to consider 'active'
    Returns dict with locality metrics per unit.
    """

    metrics = []

    num_units, num_samples = arr.shape
    for i in range(num_units):
        y = arr[i]

        max_val = np.max(np.abs(y)) + 1e-12
        threshold = threshold_ratio * max_val

        # Find region where activation > threshold
        active_idx = np.where(np.abs(y) >= threshold)[0]

        if len(active_idx) == 0:
            support_width = 0
            locality_index = 0
            left = right = -1
        else:
            left = active_idx[0]
            right = active_idx[-1]
            support_width = right - left + 1

            # Locality Index: mass on active region / total mass
            mass_total = np.sum(np.abs(y))
            mass_active = np.sum(np.abs(y[active_idx]))

            locality_index = float(mass_active / (mass_total + 1e-12))

        metrics.append({
            "unit": i,
            "support_width": support_width,
            "locality_index": locality_index,
            "left_boundary": left,
            "right_boundary": right
        })

    return metrics


def load_activation_csvs(folder):
    """
    Loads all CSV files in a folder as:
    name -> 2D numpy array (units x samples)
    """
    data = {}
    folder = Path(folder)

    for f in folder.glob("*_activations.csv"):
        name = f.stem.replace("_activations", "")
        arr = np.loadtxt(f, delimiter=",")

        # Ensure arr is (units x samples)
        if arr.ndim == 1:
            arr = arr[:, None]

        data[name] = arr

    return data


def save_plots(metrics_df, save_dir, prefix):
    Path(save_dir).mkdir(parents=True, exist_ok=True)

    # Support width histogram
    plt.figure(figsize=(6,4))
    plt.hist(metrics_df["support_width"], bins=30, alpha=0.7)
    plt.xlabel("Support Width (samples)")
    plt.ylabel("Count")
    plt.title(f"{prefix} – Support Width Distribution")
    plt.tight_layout()
    plt.savefig(os.path.join(save_dir, f"{prefix}_support_width_hist.png"), dpi=200)
    plt.close()

    # Locality histogram
    plt.figure(figsize=(6,4))
    plt.hist(metrics_df["locality_index"], bins=30, alpha=0.7)
    plt.xlabel("Locality Index")
    plt.ylabel("Count")
    plt.title(f"{prefix} – Locality Index Distribution")
    plt.tight_layout()
    plt.savefig(os.path.join(save_dir, f"{prefix}_locality_hist.png"), dpi=200)
    plt.close()

    # Scatter: locality vs width
    plt.figure(figsize=(6,4))
    plt.scatter(metrics_df["support_width"], metrics_df["locality_index"], s=15, alpha=0.6)
    plt.xlabel("Support Width")
    plt.ylabel("Locality Index")
    plt.title(f"{prefix} – Locality vs Width")
    plt.tight_layout()
    plt.savefig(os.path.join(save_dir, f"{prefix}_locality_vs_width.png"), dpi=200)
    plt.close()


def main():
    p = argparse.ArgumentParser()
    p.add_argument("--kan-dir", type=str, required=True)
    p.add_argument("--baseline-dir", type=str, required=True)
    p.add_argument("--save-dir", type=str, default="./results/interpretability/locality")
    args = p.parse_args()

    save_dir = Path(args.save_dir)
    save_dir.mkdir(parents=True, exist_ok=True)

    print("Loading activation maps...")

    kan_data = load_activation_csvs(args.kan_dir)
    baseline_data = load_activation_csvs(args.baseline_dir)

    results = []

    # Compute metrics for each module
    for name, arr in kan_data.items():
        metrics = compute_locality_metrics(arr)
        for m in metrics:
            m["module"] = name
            m["model"] = "KAN"
        results.extend(metrics)

    for name, arr in baseline_data.items():
        metrics = compute_locality_metrics(arr)
        for m in metrics:
            m["module"] = name
            m["model"] = "Baseline"
        results.extend(metrics)

    df = pd.DataFrame(results)
    csv_path = save_dir / "locality_metrics.csv"
    df.to_csv(csv_path, index=False)
    print(f"Saved locality metrics CSV → {csv_path}")

    # KAN and baseline separate plots
    df_kan = df[df["model"] == "KAN"]
    df_base = df[df["model"] == "Baseline"]

    save_plots(df_kan, save_dir, prefix="KAN")
    save_plots(df_base, save_dir, prefix="Baseline")

    print("Plots saved in:", save_dir)


if __name__ == "__main__":
    main()
